<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Титрование — Виртуальная лаборатория</title>
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src=" https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
  <style>
    .lab-container { padding: 30px 15px; max-width: 900px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    .input-group { margin: 12px 0; }
    label { display: inline-block; width: 220px; font-weight: 500; }
    input, select { padding: 6px; margin-right: 10px; }
    button {
      padding: 10px 20px;
      margin: 10px 10px 20px 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    #runBtn { background: #28a745; color: white; }
    #pdfBtn { background: #d32f2f; color: white; }
    .info-box {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .acid-row {
      display: flex;
      align-items: center;
      margin: 6px 0;
    }
    canvas {
      max-width: 100%;
      background: white;
      padding: 10px;
      border-radius: 4px;
      margin-top: 15px;
    }
    #pdf-content { display: none; }
  </style>
</head>
<body>

  <!-- Шапка -->
  <header>
    <div class="container header-content">
      <div class="logo">Виртуальная <span>лаборатория</span></div>
      <nav>
        <ul>
          <li><a href="../index.html">Главная</a></li>
          <li><a href="../theory.html">Теория</a></li>
          <li><a href="titration.html" class="active">Титрование</a></li>
          <li><a href="electrochemistry.html">Электрохимия</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="lab-container">
    <h1 style="text-align:center; margin-bottom:20px; color:#0d3b66;">Сравнение кривых титрования</h1>

    <div class="input-group">
      <label>Выберите кислоты:</label>
      <div id="acids-list"></div>
    </div>

    <div class="input-group">
      <label>Концентрация кислот (М):</label>
      <input type="number" id="c_acid" value="0.1" step="0.01" min="0.001">
    </div>

    <div class="input-group">
      <label>Объём каждой кислоты (мл):</label>
      <input type="number" id="v_acid" value="50" step="1" min="1">
    </div>

    <div class="input-group">
      <label>Концентрация NaOH (М):</label>
      <input type="number" id="c_base" value="0.1" step="0.01" min="0.001">
    </div>

    <button id="runBtn" onclick="plotComparison()">Построить кривые</button>
    <button id="pdfBtn" onclick="generatePDF()">Сохранить отчёт в PDF</button>

    <div class="info-box" id="info"></div>
    <div id="chart-container">
      <canvas id="titrationChart" height="400"></canvas>
    </div>
  </div>

  <!-- Скрытый блок для PDF -->
  <div id="pdf-content">
    <h2 style="text-align:center;">Отчёт по лабораторной работе</h2>
    <h3>Тема: Сравнение кривых титрования слабых кислот</h3>
    <p><b>Студент:</b> _________________________</p>
    <p><b>Группа:</b> _________________________</p>
    <p><b>Дата:</b> <span id="pdf-date"></span></p>
    <div id="pdf-chart" style="text-align:center; margin:20px 0;"></div>
    <div id="pdf-results" style="margin-top:20px;"></div>
    <p><b>Вывод:</b> Чем меньше pKa кислоты, тем более выражен скачок титрования и тем ниже pH в точке эквивалентности.</p>
  </div>

  <footer>
    <div class="container">
      Кафедра общей химии • ВУЗ • © 2025
    </div>
  </footer>

  <script>
    const acidsDB = [
      { id: 'CH3COOH', name: 'Уксусная (CH₃COOH)', pKa: 4.76, color: '#e74c3c' },
      { id: 'HCOOH',   name: 'Муравьиная (HCOOH)',   pKa: 3.75, color: '#3498db' },
      { id: 'C6H5COOH',name: 'Бензойная (C₆H₅COOH)',pKa: 4.20, color: '#2ecc71' }
    ];

    const Kw = 1e-14;
    let currentChart = null;
    let savedResultsHTML = '';

    function initSelectors() {
      const container = document.getElementById('acids-list');
      container.innerHTML = '';
      acidsDB.forEach(acid => {
        const div = document.createElement('div');
        div.className = 'acid-row';
        const checked = (acid.id === 'CH3COOH' || acid.id === 'HCOOH') ? 'checked' : '';
        div.innerHTML = `
          <input type="checkbox" id="chk_${acid.id}" ${checked}>
          <label for="chk_${acid.id}">${acid.name} (pKa = ${acid.pKa})</label>
        `;
        container.appendChild(div);
      });
    }

    function getSelected() {
      return acidsDB.filter(a => document.getElementById(`chk_${a.id}`)?.checked);
    }

    // Расчёт pH
    const pH_start = (c, Ka) => {
      const H = Math.sqrt(Ka * c);
      return H > 0 ? -Math.log10(H) : 7;
    };
    const pH_buffer = (cA, vA, cB, vB, Ka) => {
      const molA = cA * vA, molB = cB * vB;
      if (molB >= molA) return 7;
      return -Math.log10(Ka) + Math.log10(molB / (molA - molB));
    };
    const pH_eq = (Ka, cSalt) => {
      const OH = Math.sqrt((Kw / Ka) * cSalt);
      return OH > 0 ? 14 + Math.log10(OH) : 7;
    };
    const pH_excess = (cB, vB, vEq, vA) => {
      const OH = (cB * (vB - vEq)) / (vA + vB);
      return OH > 0 ? 14 + Math.log10(OH) : 14;
    };

    // Построение графика
    function plotComparison() {
      const acids = getSelected();
      if (acids.length === 0) return alert('Выберите хотя бы одну кислоту');

      const cA = parseFloat(document.getElementById('c_acid').value);
      const vA = parseFloat(document.getElementById('v_acid').value);
      const cB = parseFloat(document.getElementById('c_base').value);

      const datasets = [];
      let maxV = 0;
      const results = [];

      acids.forEach(acid => {
        const Ka = 10 ** (-acid.pKa);
        const vEq = (cA * vA) / cB;
        maxV = Math.max(maxV, vEq * 1.5);

        const xVals = [];
        const yVals = [];
        for (let v = 0; v <= vEq * 1.5; v += 0.5) {
          let pH;
          if (v === 0) {
            pH = pH_start(cA, Ka);
          } else if (v < vEq - 0.3) {
            pH = pH_buffer(cA, vA, cB, v, Ka);
          } else if (Math.abs(v - vEq) <= 0.3) {
            const cSalt = (cA * vA) / (vA + v);
            pH = pH_eq(Ka, cSalt);
          } else {
            pH = pH_excess(cB, v, vEq, vA);
          }
          xVals.push(parseFloat(v.toFixed(1)));
          yVals.push(parseFloat(pH.toFixed(2)));
        }

        const pH_eq_val = yVals.find((_, i) => Math.abs(xVals[i] - vEq) < 1) || '—';
        results.push(`${acid.name}: pH = ${pH_eq_val} при ${vEq.toFixed(1)} мл`);

        datasets.push({
          label: acid.name,
           yVals, // ✅ правильно: data = массив значений
          borderColor: acid.color,
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.3
        });
      });

      savedResultsHTML = `<p><b>Результаты:</b></p><ul>${results.map(r => `<li>${r}</li>`).join('')}</ul>`;
      document.getElementById('info').innerHTML = savedResultsHTML;

      const ctx = document.getElementById('titrationChart').getContext('2d');
      if (currentChart) currentChart.destroy();

      // Создаём равномерную ось X для всех кривых
      const commonX = [];
      for (let v = 0; v <= maxV; v += 0.5) commonX.push(parseFloat(v.toFixed(1)));

      currentChart = new Chart(ctx, {
        type: 'line',
         {
          labels: commonX,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: {
            x: { title: { display: true, text: 'Объём NaOH (мл)' } },
            y: { title: { display: true, text: 'pH' }, min: 0, max: 14 }
          }
        }
      });
    }

    // Генерация PDF
    async function generatePDF() {
      if (!savedResultsHTML) return alert('Сначала постройте график!');

      document.getElementById('pdf-date').textContent = new Date().toLocaleDateString('ru-RU');
      document.getElementById('pdf-results').innerHTML = savedResultsHTML;

      const canvas = document.getElementById('titrationChart');
      const imgData = canvas.toDataURL('image/png');

      const img = new Image();
      img.src = imgData;
      const pdfChart = document.getElementById('pdf-chart');
      pdfChart.innerHTML = '';
      pdfChart.appendChild(img);

      await new Promise(r => img.onload = r);

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const content = document.getElementById('pdf-content');

      const canvasPDF = await html2canvas(content, {
        scale: 2,
        backgroundColor: '#ffffff'
      });

      const imgWidth = 210;
      const imgHeight = (canvasPDF.height * imgWidth) / canvasPDF.width;
      pdf.addImage(canvasPDF, 'PNG', 0, 0, imgWidth, imgHeight);
      pdf.save('Отчёт_по_титрованию.pdf');
    }

    // Инициализация
    window.addEventListener('DOMContentLoaded', () => {
      initSelectors();
      plotComparison();
    });
  </script>
</body>
</html>
